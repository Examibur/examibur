stages:
  - docs
  - deploy

generate_pages:
  image: docker:latest
  services:
    - docker:dind
  stage: docs
  script:
  - docker build -t engineering-projekt/examibur-website docs/website/docker/
  - docker run -t --rm --name examibur-website -u jekyll -v $(pwd)/docs/:/src/ -p 4000:4000 engineering-projekt/examibur-website jekyll build -d public
  artifacts:
    paths:
    - docs/public/

pages:
  image: docker:latest
  services:
    - docker:dind
  stage: deploy
  script:
  - docker run -t --rm -e EXAMIBUR_ACCESS_TOKEN -v $(pwd)/:/src/ python:3.6 python /src/tools/backup.py gitlab
  - docker run -t --rm -e EXAMIBUR_ACCESS_TOKEN -v $(pwd)/:/src/ python:3.6 python /src/tools/report.py "/src/backups/gitlab/" "/src/docs/public/projektmanagement/resources/export/" all
  - cp -r docs/public public/
  artifacts:
    paths:
    - public
  only:
  - master
  allow_failure: true # Sadly, the gitlab export is very unreliable
